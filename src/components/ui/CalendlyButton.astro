---
import Button from "./Button.astro";
import { TrackingEvents, type EventName } from "@lib/tracking";

interface Props {
  calendlyUrl: string;
  trackingEvent?: EventName;
  size?: "sm" | "md" | "lg";
}

const { calendlyUrl, trackingEvent = TrackingEvents.CALENDLY_BOOKING_OPENED, size = "lg" } = Astro.props;
---

<Button
  size={size}
  style="primary"
  name="Meeting"
  class="calendly-trigger"
  data-calendly-url={calendlyUrl}
  data-tracking-event={trackingEvent}
>
  <slot />
</Button>

<script>
  import { track, onReady, TrackingEvents, type EventName } from "@lib/tracking";

  const validEvents = new Set<string>(Object.values(TrackingEvents));

  function initCalendlyButtons() {
    const buttons = document.querySelectorAll(".calendly-trigger");

    buttons.forEach((button) => {
      if (button.hasAttribute("data-tracking-initialized")) return;
      button.setAttribute("data-tracking-initialized", "true");

      button.addEventListener("click", (e) => {
        e.preventDefault();

        const calendlyUrl = button.getAttribute("data-calendly-url");
        const trackingEvent = button.getAttribute("data-tracking-event");

        if (!calendlyUrl) return;

        if (trackingEvent && validEvents.has(trackingEvent)) {
          track(trackingEvent as EventName);
        }

        if (window.Calendly) {
          window.Calendly.initPopupWidget({ url: calendlyUrl });
        }
      });
    });
  }

  onReady(initCalendlyButtons);
</script>
