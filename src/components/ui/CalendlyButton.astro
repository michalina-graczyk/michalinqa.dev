---
import Button from "./Button.astro";

interface Props {
  calendlyUrl: string;
  trackingEvent?: string;
  size?: "sm" | "md" | "lg";
}

const { calendlyUrl, trackingEvent = "Calendly Booking Opened", size = "lg" } = Astro.props;
---

<Button
  size={size}
  style="primary"
  name="Meeting"
  class="calendly-trigger"
  data-calendly-url={calendlyUrl}
  data-tracking-event={trackingEvent}
>
  <slot />
</Button>

<script>
  function initCalendlyButtons() {
    const buttons = document.querySelectorAll(".calendly-trigger");

    buttons.forEach((button) => {
      if (button.hasAttribute("data-calendly-initialized")) return;
      button.setAttribute("data-calendly-initialized", "true");

      button.addEventListener("click", (e) => {
        e.preventDefault();

        const calendlyUrl = button.getAttribute("data-calendly-url");
        const trackingEvent = button.getAttribute("data-tracking-event");

        if (!calendlyUrl) return;

        // Track the click
        if (window.mixpanel && trackingEvent) {
          window.mixpanel.track(trackingEvent);
        }

        // Open Calendly popup
        if (window.Calendly) {
          window.Calendly.initPopupWidget({ url: calendlyUrl });
        }
      });
    });
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCalendlyButtons);
  } else {
    initCalendlyButtons();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", initCalendlyButtons);
</script>
